<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Random Cat Tarot</title>
  <!-- <link rel="stylesheet" href="style.css"> -->
</head>
<body>
  <header>
    <h1>Your Random Cat Tarot</h1>
    <p style="margin: 0.25rem 0 1rem;">
        <a href="about.html" target="_blank" rel="noopener">About</a>
    </p>

    <button id="fetch-button">Meet a Random Cat</button>
    <button id="tarot-button" disabled>Reveal Your Cat's Tarot</button>
  </header>

  <main id="main-content"></main>

  <script>
    const triggerButton = document.getElementById('fetch-button')
    const tarotButton   = document.getElementById('tarot-button')
    const mainContent   = document.getElementById('main-content')

    let currentCatUrl = null

    //随机猫图
    triggerButton.addEventListener('click', () => {
      fetch('https://api.thecatapi.com/v1/images/search')
        .then(response => response.json())
        .then(data => {
          const catData = data[0]
          const catImage = catData.url
          currentCatUrl = catImage

          const catHTML = `
            <img id="cat-alone" src="${catImage}" alt="A random cat" width="400"/>
          `
          mainContent.innerHTML = catHTML

          const imgEl = document.getElementById('cat-alone')
          tarotButton.disabled = true
          imgEl.onload = () => { tarotButton.disabled = false }
          imgEl.onerror = () => { tarotButton.disabled = true }
        })
        .catch(error => {
          console.error('Error fetching cat image:', error)
        })
    })

    //抽塔罗牌 + 抽对应张数的扑克牌
    tarotButton.addEventListener('click', () => {
      if (!currentCatUrl) return

      fetch('https://tarotapi.dev/api/v1/cards/random?n=1')
        .then(r => r.json())
        .then(({ cards }) => {
          const c = cards && cards[0]
          if (!c) return

          const isReversed = Math.random() < 0.5
          const meaning = isReversed ? (c.meaning_rev || c.meaning_up) : (c.meaning_up || c.meaning_rev)
          const rotateStyle = isReversed ? 'transform: rotate(180deg);' : ''

          //独立容器
          const blockId = 'tarot-block-' + Date.now()
          const cardHTML = `
            <section id="${blockId}" style="margin-top:16px;">
              <div
                style="
                  width:340px;height:600px;
                  background: rgb(94,80,148);
                  border-radius:20px;
                  position:relative;
                  display:flex;align-items:center;justify-content:center;
                "
              >
                <div style="position:relative;width:300px;max-width:300px;">
                  <img
                    src="${currentCatUrl}"
                    alt="Cat on tarot"
                    style="width:300px;display:block;${rotateStyle}"
                  />
                  <div
                    style="
                      position:absolute;left:50%;top:50%;
                      transform: translate(-50%,-50%);
                      color:#fff;text-align:center;
                      font-size:48px;
                    "
                  ">${c.name}</div>
                </div>
              </div>
              <div class="tarot-meaning" style="max-width:340px;margin-top:8px;">
                ${meaning}
              </div>
              <div class="playing-cards-row" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;"></div>
            </section>
          `
          mainContent.insertAdjacentHTML('beforeend', cardHTML)

          //用value_int抽扑克牌
          let n = Number(c.value_int)
          if (!Number.isFinite(n)) n = 1
          n = Math.max(1, Math.min(n, 52))

          return fetch(`https://deckofcardsapi.com/api/deck/new/draw/?count=${n}`)
            .then(r => r.json())
            .then(deck => {
              const row = document.querySelector(`#${blockId} .playing-cards-row`)
              const cards = deck?.cards || []
              if (!row) return
              if (!cards.length) {
                row.innerHTML = `<p style="color:#666;">No playing cards returned.</p>`
                return
              }
              row.innerHTML = cards.map(pc => `
                <img src="${pc.image}" alt="${pc.code}" width="100" height="auto" loading="lazy"/>
              `).join('')
            })
        })
        .catch(err => {
          console.error(err)
        })
    })
  </script>
</body>
</html>
